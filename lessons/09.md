# Lesson 9
## Routes for creating, updating and deleting data

| Lesson objectives                            | Course objectives                        |
|:---------------------------------------------|:-----------------------------------------|
| Design and implement POST, PUT/PATCH | Design and implement CRUD routes in a Rails app | 
| Validate user form input and respond with informative error messages | Test a Rails app using automated and manual test | 
| Test your routes with Rspec request specs | |

Let's review the list of requirements for the Dream of Code app:

1. We'd like a dashboard that lists the courses for the current and upcoming trimester.
2. Each of those courses should link to a page that shows the list of enrolled students (for current courses).
3. On the dashboard, there should be a link to a form for adding a new course.
4. On each course page, there should be a link to a form to enroll a student in the course.
5. We need to be able to update the application deadline for the upcoming trimester.
6. Only Dream of Code staff should be able to view student enrollments, create courses and update trimesters.
7. Only students may submit assignments. Only mentors may edit them. A student may see their own info, but other students should not be able to. (There are a list of 'authorization' rules like this.)
8. We need an API endpoint that lists the students enrolled for a course.

This week, we'll implement #3 and #4. You'll do #5 on your own for your assignment.

### Creating a new course form
Here's a wireframe for how our form might look:

TODO wireframe

Notice we'll need a route that displays a form, then we'll also need a route for the form submission. When we click "submit" on the form, we expect that a new course is created.

Let's revisit our steps to create a (GET) route:
1. Define the route, and map the route to a controller and action
2. Respond to the request with HTML (an outline with static data at first)
3. Collect the data we want to display and include that in our HTML reponse

The route to display the form is reading and displaying data, so we'll use the GET verb for that route. But the route for the form submission should create data, so we should define that route to expect the POST verb or method. The steps to create a POST or PUT route are a little different:

1. Define the route, and map the route to a controller and action
2. Create the new data if possible
  a. Respond with a success message if the new data is created and redirect to a new route.
  b. Respond with an appropriate error message if the new data is not created and redirect back to the form.

### The route to display the form:
1. HTTP Method
  - As mentioned, we'll use GET.
2. Path
  - Since we are creating a new resource (a course), we should follow the convention in [this table](https://guides.rubyonrails.org/routing.html#crud-verbs-and-actions). So our path will be `/courses/new`.
3. Controller and action
  - Again, since we are defining "resourceful routes", we should follow Rails conventions, which says our controller will be `courses_controller.rb` and the action will be `new`.

### The route for form submission:
1. HTTP Method
  - As mentioned, we'll use POST.
2. Path
  - Since we are creating a new resource (a course), we should follow the convention in [this table](https://guides.rubyonrails.org/routing.html#crud-verbs-and-actions). So our path will be `/courses`.
3. Controller and action
  - Again, since we are defining a "resourceful route", we should follow Rails conventions, which says our controller will be `courses_controller.rb` and the action will be `create`.

You'll see in the app that the `courses_controller.rb` already exists, as does a new action and a new view. The routes are also already set up in `config/routes.rb`. Visit `http://localhost:3000/courses/new` to verify the form displays.

TODO walkthrough posting form, validation, etc

### Creating an enrollment form
After some discussion with Dream of Code staff, we learn that on the enrollment form, the user should be able to select an existing student to enroll from a dropdown, but there should also be an option to enroll a student that hasn't yet taken any Dream of Code classes. So this form will also create the student record in this case.

Here's our wireframe for the form:

TODO wireframe for enrollment form (student dropdown + add student form option)

We're displaying a form and submitting a form, just like when creating a course, so we'll need a GET route to display the form, and a POST route for the form submission. Since an enrollment is a resource in our app, we can use the Rails conventions for these routes.

#### Resource routes and scaffolding
Now that we're comfortable with the structure of routes, we'll start using the convenience method for resources when it makes sense. For enrollments, each of the seven routes generated by the `resources` method is likely to be of use in our application, as we can imagine we'll need to create and enrollment, view an enrollment, list all enrollments, update and enrollment and delete and enrollment at some point. So let's add this to `config/routes.rb`

```
resources :enrollments
```

We've also seen that when implementing CRUD for resources, we follow the same patterns, creating the model, view, controller, migration, routes, etc all carefully following conventions Rails expects. The `rails` executable offers generators that can build any or all of this "scaffolding" for a resource in one command. You can read about generators in the [Rails Guides](https://guides.rubyonrails.org/command_line.html#bin-rails-generate). Let's use a generator to create the enrollments controller.

Anytime we use a command line tool, we'll need to check the options available to be sure we know what we're getting. Very often, you can access options by running the command with a help flag `--help` following:
```
bin/rails generate controller --help

```
Take a minute or two to look over the output. You'll see we also have Rspec options because we have rspec-rails installed. Ruby gems built for Rails will frequently add functionality to Rails generators, which makes the tools easier for Rails developers to use, since the patterns are familiar.

In the description section, you'll see that both the controller and views will be created with this command. You can see that there are a lot of different types of rspec specs that the command will create by default. We aren't writing view specs, routing specs or helper specs for this app, so let's skip those. Also, we can skip the helper file. If we need that, we can create it later.

```
bin/rails generate controller enrollments --no-view-specs --no-routing-specs --no-helper-specs --no-helper
```

You should see a list of files the generator created. Take a minute to look at them all. Run the specs and read through the test cases. Start the server and navigate to the enrollments routes.

So we have a good starting point for our enrollments form, but it's not quite what we need for our app. This is common. It's rare that the default views, routes and controller actions will be exactly the functionality we need. (If it was, we could probably just use Airtable or something similar.)

Let's adjust the form:

TODO html for form

We need to display existing students on the form

TODO get students for form

Now we need to adjust what happens on submit

TODO create enrollment and possibly student

